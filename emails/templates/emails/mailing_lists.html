{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h1>Cyphy.life Mailing Lists</h1>

    {% if messages %}
    <div class="messages mb-4">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <div class="row">
        <!-- Mailing Lists Overview -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Available Mailing Lists</h5>
                </div>
                <div class="card-body">
                    {% for list in mailing_lists %}
                    <div class="mb-4">
                        <h6>{{ list.alias }}</h6>
                        {% if list.description %}
                        <p class="text-muted small">{{ list.description }}</p>
                        {% endif %}
                        <div class="small">
                            <strong>Subscribers ({{ list.subscribers.count }}):</strong>
                            <ul class="list-unstyled ms-3">
                                {% for subscriber in list.subscribers.all %}
                                <li class="d-flex align-items-center justify-content-between">
                                    {{ subscriber.email }}
                                    <button class="btn btn-sm btn-link text-danger unsubscribe-btn"
                                            data-email="{{ subscriber.email }}"
                                            data-list-id="{{ list.id }}">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Subscription Form -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Subscribe to Mailing Lists</h5>
                </div>
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="{{ form.email.id_for_label }}" class="form-label">Your Email Address</label>
                            {{ form.email }}
                            <div class="form-text">Enter your email to subscribe to mailing lists</div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Select Mailing Lists:</label>
                            {% for list in mailing_lists %}
                            <div class="form-check">
                                <input type="checkbox"
                                       name="mailing_lists"
                                       value="{{ list.id }}"
                                       class="form-check-input"
                                       id="list_{{ list.id }}">
                                <label class="form-check-label" for="list_{{ list.id }}">
                                    {{ list.alias }}
                                    {% if list.description %}
                                    <small class="text-muted">- {{ list.description }}</small>
                                    {% endif %}
                                </label>
                            </div>
                            {% endfor %}
                        </div>

                        <button type="submit" class="btn btn-primary">Subscribe</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Font Awesome for the X icon -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">

<!-- Add jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
$(document).ready(function() {
    // Setup CSRF token for AJAX requests
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // Handle unsubscribe button clicks
    $('.unsubscribe-btn').click(function() {
        const btn = $(this);
        const email = btn.data('email');
        const listId = btn.data('list-id');

        if (confirm('Are you sure you want to unsubscribe this email?')) {
            $.ajax({
                url: '',
                type: 'POST',
                data: {
                    'email': email,
                    'list_id': listId,
                },
                headers: {
                    'X-CSRFToken': csrftoken,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                success: function(response) {
                    if (response.status === 'success') {
                        btn.closest('li').fadeOut(function() {
                            $(this).remove();
                        });
                    } else {
                        alert('Error unsubscribing. Please try again.');
                    }
                },
                error: function() {
                    alert('Error unsubscribing. Please try again.');
                }
            });
        }
    });
});
</script>
{% endblock %}
